<!DOCTYPE html>

<html xmlns="http://www.w3.org/1999/xhtml">

<head>

<meta charset="utf-8" />
<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
<meta name="generator" content="pandoc" />


<meta name="author" content="Fernando Campos" />

<meta name="date" content="2017-08-19" />

<title>Santa Rosa Fruit Biomass</title>

<script src="site_libs/jquery-1.11.3/jquery.min.js"></script>
<meta name="viewport" content="width=device-width, initial-scale=1" />
<link href="site_libs/bootstrap-3.3.5/css/cosmo.min.css" rel="stylesheet" />
<script src="site_libs/bootstrap-3.3.5/js/bootstrap.min.js"></script>
<script src="site_libs/bootstrap-3.3.5/shim/html5shiv.min.js"></script>
<script src="site_libs/bootstrap-3.3.5/shim/respond.min.js"></script>
<script src="site_libs/jqueryui-1.11.4/jquery-ui.min.js"></script>
<link href="site_libs/tocify-1.9.1/jquery.tocify.css" rel="stylesheet" />
<script src="site_libs/tocify-1.9.1/jquery.tocify.js"></script>
<script src="site_libs/navigation-1.1/tabsets.js"></script>
<script src="site_libs/navigation-1.1/codefolding.js"></script>
<link href="site_libs/font-awesome-4.5.0/css/font-awesome.min.css" rel="stylesheet" />


<style type="text/css">code{white-space: pre;}</style>
<style type="text/css">
div.sourceCode { overflow-x: auto; }
table.sourceCode, tr.sourceCode, td.lineNumbers, td.sourceCode {
  margin: 0; padding: 0; vertical-align: baseline; border: none; }
table.sourceCode { width: 100%; line-height: 100%; background-color: #f8f8f8; }
td.lineNumbers { text-align: right; padding-right: 4px; padding-left: 4px; color: #aaaaaa; border-right: 1px solid #aaaaaa; }
td.sourceCode { padding-left: 5px; }
pre, code { background-color: #f8f8f8; }
code > span.kw { color: #204a87; font-weight: bold; } /* Keyword */
code > span.dt { color: #204a87; } /* DataType */
code > span.dv { color: #0000cf; } /* DecVal */
code > span.bn { color: #0000cf; } /* BaseN */
code > span.fl { color: #0000cf; } /* Float */
code > span.ch { color: #4e9a06; } /* Char */
code > span.st { color: #4e9a06; } /* String */
code > span.co { color: #8f5902; font-style: italic; } /* Comment */
code > span.ot { color: #8f5902; } /* Other */
code > span.al { color: #ef2929; } /* Alert */
code > span.fu { color: #000000; } /* Function */
code > span.er { color: #a40000; font-weight: bold; } /* Error */
code > span.wa { color: #8f5902; font-weight: bold; font-style: italic; } /* Warning */
code > span.cn { color: #000000; } /* Constant */
code > span.sc { color: #000000; } /* SpecialChar */
code > span.vs { color: #4e9a06; } /* VerbatimString */
code > span.ss { color: #4e9a06; } /* SpecialString */
code > span.im { } /* Import */
code > span.va { color: #000000; } /* Variable */
code > span.cf { color: #204a87; font-weight: bold; } /* ControlFlow */
code > span.op { color: #ce5c00; font-weight: bold; } /* Operator */
code > span.pp { color: #8f5902; font-style: italic; } /* Preprocessor */
code > span.ex { } /* Extension */
code > span.at { color: #c4a000; } /* Attribute */
code > span.do { color: #8f5902; font-weight: bold; font-style: italic; } /* Documentation */
code > span.an { color: #8f5902; font-weight: bold; font-style: italic; } /* Annotation */
code > span.cv { color: #8f5902; font-weight: bold; font-style: italic; } /* CommentVar */
code > span.in { color: #8f5902; font-weight: bold; font-style: italic; } /* Information */
div.sourceCode {
  overflow-x: visible;
}
</style>
<style type="text/css">
  pre:not([class]) {
    background-color: white;
  }
</style>


<style type="text/css">
h1 {
  font-size: 34px;
}
h1.title {
  font-size: 38px;
}
h2 {
  font-size: 30px;
}
h3 {
  font-size: 24px;
}
h4 {
  font-size: 18px;
}
h5 {
  font-size: 16px;
}
h6 {
  font-size: 12px;
}
.table th:not([align]) {
  text-align: left;
}
</style>


</head>

<body>

<style type = "text/css">
.main-container {
  max-width: 940px;
  margin-left: auto;
  margin-right: auto;
}
code {
  color: inherit;
  background-color: rgba(0, 0, 0, 0.04);
}
img {
  max-width:100%;
  height: auto;
}
.tabbed-pane {
  padding-top: 12px;
}
button.code-folding-btn:focus {
  outline: none;
}
</style>


<style type="text/css">
/* padding for bootstrap navbar */
body {
  padding-top: 51px;
  padding-bottom: 40px;
}
/* offset scroll position for anchor links (for fixed navbar)  */
.section h1 {
  padding-top: 56px;
  margin-top: -56px;
}

.section h2 {
  padding-top: 56px;
  margin-top: -56px;
}
.section h3 {
  padding-top: 56px;
  margin-top: -56px;
}
.section h4 {
  padding-top: 56px;
  margin-top: -56px;
}
.section h5 {
  padding-top: 56px;
  margin-top: -56px;
}
.section h6 {
  padding-top: 56px;
  margin-top: -56px;
}
</style>

<script>
// manage active state of menu based on current page
$(document).ready(function () {
  // active menu anchor
  href = window.location.pathname
  href = href.substr(href.lastIndexOf('/') + 1)
  if (href === "")
    href = "index.html";
  var menuAnchor = $('a[href="' + href + '"]');

  // mark it active
  menuAnchor.parent().addClass('active');

  // if it's got a parent navbar menu mark it active as well
  menuAnchor.closest('li.dropdown').addClass('active');
});
</script>


<div class="container-fluid main-container">

<!-- tabsets -->
<script>
$(document).ready(function () {
  window.buildTabsets("TOC");
});
</script>

<!-- code folding -->
<style type="text/css">
.code-folding-btn { margin-bottom: 4px; }
</style>
<script>
$(document).ready(function () {
  window.initializeCodeFolding("show" === "show");
});
</script>




<script>
$(document).ready(function ()  {

    // move toc-ignore selectors from section div to header
    $('div.section.toc-ignore')
        .removeClass('toc-ignore')
        .children('h1,h2,h3,h4,h5').addClass('toc-ignore');

    // establish options
    var options = {
      selectors: "h1,h2,h3",
      theme: "bootstrap3",
      context: '.toc-content',
      hashGenerator: function (text) {
        return text.replace(/[.\\/?&!#<>]/g, '').replace(/\s/g, '_').toLowerCase();
      },
      ignoreSelector: ".toc-ignore",
      scrollTo: 0
    };
    options.showAndHide = true;
    options.smoothScroll = true;

    // tocify
    var toc = $("#TOC").tocify(options).data("toc-tocify");
});
</script>

<style type="text/css">

#TOC {
  margin: 25px 0px 20px 0px;
}
@media (max-width: 768px) {
#TOC {
  position: relative;
  width: 100%;
}
}


.toc-content {
  padding-left: 30px;
  padding-right: 40px;
}

div.main-container {
  max-width: 1200px;
}

div.tocify {
  width: 20%;
  max-width: 260px;
  max-height: 85%;
}

@media (min-width: 768px) and (max-width: 991px) {
  div.tocify {
    width: 25%;
  }
}

@media (max-width: 767px) {
  div.tocify {
    width: 100%;
    max-width: none;
  }
}

.tocify ul, .tocify li {
  line-height: 20px;
}

.tocify-subheader .tocify-item {
  font-size: 0.90em;
  padding-left: 25px;
  text-indent: 0;
}

.tocify .list-group-item {
  border-radius: 0px;
}


</style>

<!-- setup 3col/9col grid for toc_float and main content  -->
<div class="row-fluid">
<div class="col-xs-12 col-sm-4 col-md-3">
<div id="TOC" class="tocify">
</div>
</div>

<div class="toc-content col-xs-12 col-sm-8 col-md-9">




<div class="navbar navbar-default  navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar">
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <a class="navbar-brand" href="index.html">Code</a>
    </div>
    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
        <li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-expanded="false">
    R Packages
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
    <li>
      <a href="r-packages-plhdbR.html">plhdbR</a>
    </li>
    <li>
      <a href="r-packages-paceR.html">paceR</a>
    </li>
    <li>
      <a href="r-packages-ClimGrid.html">ClimGrid</a>
    </li>
  </ul>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-expanded="false">
    Reproducible Analysis
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
    <li class="dropdown-header">Moose</li>
    <li>
      <a href="moose-migration-repeatability.html">Migration Repeatability</a>
    </li>
    <li class="divider"></li>
    <li class="dropdown-header">Capuchins</li>
    <li>
      <a href="capuchin-home-ranges.html">Capuchin Home Ranges</a>
    </li>
  </ul>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-expanded="false">
    PACE Tutorials
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
    <li>
      <a href="pace-fruit-biomass.html">Fruit Biomass</a>
    </li>
    <li class="dropdown-header">Leaf Seasonality (in prep)</li>
    <li class="dropdown-header">Weather Data (in prep)</li>
  </ul>
</li>
      </ul>
      <ul class="nav navbar-nav navbar-right">
        <li>
  <a href="https://github.com/camposfa">
    <span class="fa fa-github fa-lg"></span>
     
  </a>
</li>
<li>
  <a href="https://people.duke.edu/~fac13">
    <span class="fa fa-home fa-lg"></span>
     
  </a>
</li>
      </ul>
    </div><!--/.nav-collapse -->
  </div><!--/.container -->
</div><!--/.navbar -->

<div class="fluid-row" id="header">

<div class="btn-group pull-right">
<button type="button" class="btn btn-default btn-xs dropdown-toggle" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false"><span>Code</span> <span class="caret"></span></button>
<ul class="dropdown-menu" style="min-width: 50px;">
<li><a id="rmd-show-all-code" href="#">Show All Code</a></li>
<li><a id="rmd-hide-all-code" href="#">Hide All Code</a></li>
</ul>
</div>



<h1 class="title toc-ignore">Santa Rosa Fruit Biomass</h1>
<h4 class="author"><em>Fernando Campos</em></h4>
<h4 class="date"><em>2017-08-19</em></h4>

</div>


<div id="overview" class="section level1">
<h1>Overview</h1>
<p>The fruit biomass calculations are based on three primary data sets:</p>
<ol style="list-style-type: decimal">
<li>Phenology data is used to determine when and to what degree ripe fruit is available for each food tree species.</li>
<li>Transect data is used to determine the abundance of each food tree species.</li>
<li>FPV data is used to determine which trees in the transect data are capable of bearing fruit and feeding monkeys.</li>
</ol>
<p>The first two data sets can be pulled directly from the PACE database. The FPV data is not (yet) in the database, so it has to be loaded from a CSV file. Ask <a href="mailto:facampos@ucalgary.ca">Fernando</a> for this file if you don’t already have it.</p>
</div>
<div id="first-steps" class="section level1">
<h1>First Steps</h1>
<p>Before doing anything, you must install the <code>paceR</code> package for R and set up your connections to the PACE database. There are instructions for doing this <a href="https://github.com/camposfa/paceR">here</a>. This is the largest hurdle and <strong>nothing else will work until this is done correctly!</strong></p>
<p>Then you can load the required packages:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">  <span class="kw">library</span>(paceR)
  <span class="kw">load_pace_packages</span>()</code></pre></div>
<p>and create connections to the “monkey” and “paceR” databases.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">  <span class="co"># Connect to monkey database</span>
  pace_db &lt;-<span class="st"> </span><span class="kw">src_mysql</span>(<span class="dt">group =</span> <span class="st">&quot;PACE&quot;</span>, <span class="dt">user =</span> <span class="st">&quot;camposf&quot;</span>, <span class="dt">dbname =</span> <span class="st">&quot;monkey&quot;</span>, <span class="dt">password =</span> <span class="ot">NULL</span>)
  
  <span class="co"># Connect to paceR database  </span>
  paceR_db &lt;-<span class="st"> </span><span class="kw">src_mysql</span>(<span class="dt">group =</span> <span class="st">&quot;PACE&quot;</span>, <span class="dt">user =</span> <span class="st">&quot;camposf&quot;</span>, <span class="dt">dbname =</span> <span class="st">&quot;paceR&quot;</span>, <span class="dt">password =</span> <span class="ot">NULL</span>)</code></pre></div>
<p>Then we can get the required data:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="co"># Use special phenology query</span>
ph &lt;-<span class="st"> </span><span class="kw">getv_Phenology</span>(paceR_db, <span class="dt">project =</span> <span class="st">&quot;SR&quot;</span>)
<span class="co"># No special transect query, so just get raw table</span>
tr &lt;-<span class="st"> </span><span class="kw">get_pace_tbl</span>(paceR_db, <span class="st">&quot;vVegetationTransect&quot;</span>)
<span class="co"># Read in FPV file (not currently in PACE!)</span>
fpv &lt;-<span class="st"> </span><span class="kw">tbl_df</span>(<span class="kw">read.csv</span>(<span class="st">&quot;_data/pace-fruit-biomass/AllFPV.csv&quot;</span>))

<span class="co"># Read most recent fig file</span>
figs &lt;-<span class="st"> </span><span class="kw">tbl_df</span>(<span class="kw">read.csv</span>(<span class="st">&quot;_data/pace-fruit-biomass/FicusData_Nov13_2013.csv&quot;</span>))

<span class="co"># Create set of species to exclude</span>
exclude_species &lt;-<span class="st"> </span><span class="kw">c</span>(<span class="st">&quot;SCAP&quot;</span>, <span class="st">&quot;SPAV&quot;</span>, <span class="st">&quot;CCAN&quot;</span>, <span class="st">&quot;BUNG&quot;</span>, <span class="st">&quot;HCOU&quot;</span>,
                     <span class="st">&quot;ATIB&quot;</span>, <span class="st">&quot;GULM&quot;</span>, <span class="st">&quot;LCAN&quot;</span>, <span class="st">&quot;LSPE&quot;</span>, <span class="st">&quot;FUNK&quot;</span>)</code></pre></div>
</div>
<div id="calculations" class="section level1">
<h1>Calculations</h1>
<p>The easiest way to calculate monthly fruit biomass for Santa Rosa is to use the convenient function <code>get_biomass_sr()</code>. This is basically a “wrapper” around a longer script that calls different functions one-by-one. These task-specific functions are also available to be used, but they’re not explained here. The advantage to using <code>get_biomass_sr</code> is that it’s very easy. The advantage to using the lower-level functions is that they provide access to other useful information.</p>
<p>This package implements three different methods for calculating fruit biomass. The method is controlled by the parameter called “smooth” that is supplied to the <code>get_biomass_sr</code> function.</p>
<div id="no-smoothing" class="section level2">
<h2>No Smoothing</h2>
<p>When the function is called with <code>smooth = &quot;none&quot;</code>, the raw availability indices are averaged for each species in each month and these values are used to calculate biomass for each species.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">biomass_avail_raw &lt;-<span class="st"> </span><span class="kw">get_biomass_sr</span>(ph, tr, fpv, figs, exclude_species, 
                                    <span class="dt">smooth =</span> <span class="st">&quot;none&quot;</span>)</code></pre></div>
<p>We can look at some of the values…</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">biomass_avail_raw <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">select</span>(SpeciesName, year_of, month_of, biomass_monthly_kg)</code></pre></div>
<pre><code>## # A tibble: 5,362 x 4
## # Groups:   SpeciesName, year_of [478]
##         SpeciesName year_of month_of biomass_monthly_kg
##               &lt;chr&gt;  &lt;fctr&gt;   &lt;fctr&gt;              &lt;dbl&gt;
##  1 Alibertia edulis    2007      Feb           0.000000
##  2 Alibertia edulis    2007      Mar           4.257945
##  3 Alibertia edulis    2007      Apr           0.000000
##  4 Alibertia edulis    2007      May           0.000000
##  5 Alibertia edulis    2007      Jun           1.520695
##  6 Alibertia edulis    2007      Jul           1.520695
##  7 Alibertia edulis    2007      Aug           0.000000
##  8 Alibertia edulis    2007      Oct           1.140521
##  9 Alibertia edulis    2007      Nov           8.363821
## 10 Alibertia edulis    2007      Dec           0.000000
## # ... with 5,352 more rows</code></pre>
<p>The function <code>plot_biomass_species</code> visualizes this using a heatmap.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">plot_biomass_species</span>(biomass_avail_raw)</code></pre></div>
<p><img src="figures/pace-fruit-biomass/plot_biomass_raw-1.png" width="1152" /></p>
<p>Summarise the data by adding up all species in each month.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">b_summary_raw &lt;-<span class="st"> </span><span class="kw">biomass_monthly_summary</span>(biomass_avail_raw)</code></pre></div>
<p>Now plot the summary.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">plot_biomass_monthly</span>(b_summary_raw)</code></pre></div>
<p><img src="figures/pace-fruit-biomass/plot_summary_biomass_raw-1.png" width="672" /></p>
</div>
<div id="loess-smoothing" class="section level2">
<h2>Loess Smoothing</h2>
<p>When the function is called with <code>smooth = &quot;loess&quot;</code>, the raw availability indices are smoothed using <a href="https://stat.ethz.ch/R-manual/R-patched/library/stats/html/loess.html">Local Polynomial Regression Fitting</a>. The loess smoother is applied to each species and year separately, which allows the seasonal pattern of fruiting for a given species to differ from year to year.</p>
<p>Let’s carry out the same steps with this method. First for each species.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">biomass_avail_lo &lt;-<span class="st"> </span><span class="kw">get_biomass_sr</span>(ph, tr, fpv, figs, exclude_species, 
                                   <span class="dt">smooth =</span> <span class="st">&quot;loess&quot;</span>)
<span class="kw">plot_biomass_species</span>(biomass_avail_lo)</code></pre></div>
<p><img src="figures/pace-fruit-biomass/biomass_lo-1.png" width="1152" /></p>
<p>And then the summary. This smoothing method produces an overall pattern similar to the raw scores, but its main effects are 1) dampening/devaluing extreme values and outliers, and 2) allowing availability scores in adjacent months to have some influence on each other.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">b_summary_lo &lt;-<span class="st"> </span><span class="kw">biomass_monthly_summary</span>(biomass_avail_lo)
<span class="kw">plot_biomass_monthly</span>(b_summary_lo)</code></pre></div>
<p><img src="figures/pace-fruit-biomass/plot_biomass_lo-1.png" width="672" /></p>
</div>
<div id="gamm-smoothing" class="section level2">
<h2>GAMM Smoothing</h2>
<p>When the function is called with <code>smooth = &quot;gam&quot;</code>, the raw availability indices are smoothed using <a href="https://stat.ethz.ch/R-manual/R-devel/library/mgcv/html/gamm.html">Generalized Additive Mixed Models</a>. This is applied to each species separately. This smoothing method assumes that <em>the month-to-month fruiting pattern for a given species is the same from year to year</em>; what differs is the degree to which that species’ cycle is expressed in any particular year. This assumption is probably bad for some species (like <em>Ficus</em>), but it’s probably a reasonable assumption for many species.</p>
<p>Let’s carry out the same steps with this method. First for each species.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">biomass_avail_gam &lt;-<span class="st"> </span><span class="kw">get_biomass_sr</span>(ph, tr, fpv, figs, exclude_species, 
                                    <span class="dt">smooth =</span> <span class="st">&quot;gam&quot;</span>)
<span class="kw">plot_biomass_species</span>(biomass_avail_gam)</code></pre></div>
<p><img src="figures/pace-fruit-biomass/plot_biomass_gam-1.png" width="1152" /></p>
<p>And then the summary. This produces an overall pattern that is approximately the same across years as far as the <em>timing</em> of fruit abundance peaks and troughs for each species. The pattern differs quite a bit from the others. I think the main strengths of this method are that it’s easy to identify variation around the “typical” conditions, e.g., which months tend to have higher or lower fruit abundance, and which years are relatively good or bad.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">b_summary_gam &lt;-<span class="st"> </span><span class="kw">biomass_monthly_summary</span>(biomass_avail_gam)
<span class="kw">plot_biomass_monthly</span>(b_summary_gam)</code></pre></div>
<p><img src="figures/pace-fruit-biomass/summary_biomass_gam-1.png" width="672" /></p>
</div>
</div>
<div id="comparison" class="section level1">
<h1>Comparison</h1>
<p>Finally, we can make a side-by-side plot of the three methods</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="co"># Side by side plot</span>
b_summary_raw<span class="op">$</span>method &lt;-<span class="st"> &quot;none&quot;</span>
b_summary_gam<span class="op">$</span>method &lt;-<span class="st"> &quot;gam&quot;</span>
b_summary_lo<span class="op">$</span>method &lt;-<span class="st"> &quot;loess&quot;</span>
temp &lt;-<span class="st"> </span><span class="kw">bind_rows</span>(b_summary_raw, b_summary_lo, b_summary_gam)
temp<span class="op">$</span>method &lt;-<span class="st"> </span><span class="kw">factor</span>(temp<span class="op">$</span>method, <span class="dt">levels =</span> <span class="kw">c</span>(<span class="st">&quot;none&quot;</span>, <span class="st">&quot;loess&quot;</span>, <span class="st">&quot;gam&quot;</span>))
<span class="kw">plot_biomass_monthly</span>(temp) <span class="op">+</span><span class="st"> </span><span class="kw">facet_wrap</span>(<span class="op">~</span>method)</code></pre></div>
<p><img src="figures/pace-fruit-biomass/compare_all-1.png" width="1056" /></p>
</div>



</div>
</div>

</div>

<script>

// add bootstrap table styles to pandoc tables
function bootstrapStylePandocTables() {
  $('tr.header').parent('thead').parent('table').addClass('table table-condensed');
}
$(document).ready(function () {
  bootstrapStylePandocTables();
});


</script>

<!-- dynamically load mathjax for compatibility with self-contained -->
<script>
  (function () {
    var script = document.createElement("script");
    script.type = "text/javascript";
    script.src  = "https://mathjax.rstudio.com/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML";
    document.getElementsByTagName("head")[0].appendChild(script);
  })();
</script>

</body>
</html>
